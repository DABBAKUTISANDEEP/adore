<!--
********************************************************************************
* Copyright (C) 2017-2020 German Aerospace Center (DLR). 
* Eclipse ADORe, Automated Driving Open Research https://eclipse.org/adore
*
* This program and the accompanying materials are made available under the 
* terms of the Eclipse Public License 2.0 which is available at
* http://www.eclipse.org/legal/epl-2.0.
*
* SPDX-License-Identifier: EPL-2.0 
*
* Contributors: 
*   Daniel HeÃŸ - initial API and implementation
********************************************************************************
-->


# Development guide
This guide provides information on the suggested workflow to develop with and for this framework.
For a style guide please have a look [here](styleguide.md).

## Software documentation
To generate doxygen files, execute [documentation/generate_docs.bash](generate_docs.bash).
Please refer to [docstyle](docstyle.md) in order to properly document the source code.

## Document license and authors
Please use examples "documentation/license_header_template.*" to stamp the beginning of your files.

## How to create a new application
The binaries that embody the parts of an autonomous driving scenario - i.e. planner, controller, status monitor - we call apps. In the context of ROS these are basically ROS nodes which communicate using ROS messages and topics. The framework abstracts from ROS by design. Therefore each app will consist of the system-independent code placed in libadore under "adore/apps" and a ROS specific part placed in a cpp file in "adore_if_ros". The cpp file in "adore_if_ros" has to contain a minimum amount of code and should dispatch calls to libadore. 
Register the new application and its .cpp file in "adore_if_ros/CMakeLists.txt".

## Configure catkin to install mode
~~~bash
catkin config --install
~~~

## Build adore binaries for ROS
~~~bash
cd ~adore
catkin build adore_if_ros
~~~

## Execute a launch file
Make sure paths are set. Then navigate to the folder with the launch file and execute roslaunch.
~~~bash
source ~/catkin_ws/install/setup.bash
cd ~/catkin_ws/src/adore/adore_if_ros_demos
roslaunch xy.launch
~~~

## Some information, which might be useful to get started with SUMO
Can be found [here](sumo.md).

## Start a ros node
Make sure paths are set. Use rosrun to start the node, with package and node name as parameters.
~~~bash
source ~/catkin_ws/install/setup.bash
rosrun adore_if_ros nodexy
~~~

## Debug a ros node
Configure catkin to build Debug. Setup a launch.json in your .vscode folder to start debugging from VS code.
~~~bash
catkin config --cmake-args -DCMAKE_BUILD_TYPE=Debug
~~~
If you want to attach to a running process, add the following to your launch.json:
~~~json
{
  "version": "0.2.0",
  "configurations": [

    {
      "name": "ROS: Attach",
      "type": "ros",
      "request": "attach"
    }
  ]
}
~~~
If you want to start a process via VS code, add the following to your launch.json:
~~~json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "adore_feedbackcontroller_node",
      "type": "cppdbg",
      "request": "launch",
      "program": "${workspaceFolder}/../../install/lib/adore_if_ros/adore_feedbackcontroller_node",
      "args": ["__ns:=/vehicle0"],
      "stopAtEntry": false,
      "cwd": "${workspaceFolder}/..",
      "environment": [],
      "externalConsole": false,
      "MIMode": "gdb",
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        }
      ]
    }
  ]
}
~~~
The namespace of a ros node is configured by '"args": ["__ns:=/the-name-space"]'.
An examplary launch.json can be found [here](launch.json).


## Switch to Release Mode
```bash
catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release
```



## Profile a Process
If gcc is configured with the parameter "-pg", the resulting binary will output profiling information.
The following will enable profiling for cmake:
~~~bash
cmake -DCMAKE_CXX_FLAGS=-pg -DCMAKE_EXE_LINKER_FLAGS=-pg -DCMAKE_SHARED_LINKER_FLAGS=-pg <SOURCE_DIR>
~~~
Enable the cmake options for catkin:
```bash
catkin config --cmake-args -DCMAKE_CXX_FLAGS=-pg -DCMAKE_EXE_LINKER_FLAGS=-pg -DCMAKE_SHARED_LINKER_FLAGS=-pg 
```
A file gmon.out should be generated by the process in the folder ~/.ros.
It seems that all processes then write gmon.out. So the file corresponds to the last process shutting down. You might want to stop a process slectively to ensure you have the right output file.
The result can be made readable with gprof:
~~~bash
gprof executablename gmon.out > analysis.txt
~~~
Search for "Call graph" section in the file as a good starting point.

## Test libadore

The libadore library can be built and tested seperately:

~~~bash
cd ~/catkin_ws/src/adore/libadore
mkdir build
cd build
cmake .. -DBUILD_adore_TESTING=true
make
make test
~~~

To automatically build and run tests as part of the catkin build process the catkin workspace can be configured as follows:

~~~bash
cd ~/catkin_ws
catkin config --install --make-args install all test --catkin-make-args run_tests --cmake-args -DBUILD_adore_TESTING=ON
catkin build adore_if_ros
~~~

If using ROS Noetic and catkin is installed in catkin_ws/src: Create a file "CATKIN_IGNORE" in ~/catkin_ws/src/catkin
~~~bash
cd ~/catkin_ws/src/catkin
touch CATKIN_IGNORE
~~~

During normal build only failed tests are reported. To manually trigger the tests run:

~~~bash
cd ~/catkin_ws/build/adore_if_ros
ctest
~~~
